<!DOCTYPE html>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" >
<!-- jruby -run -e httpd . -p 9090 -->

<head>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/normalize/4.1.1/normalize.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.1/animate.min.css">
  <link rel='stylesheet' href='//fonts.googleapis.com/css?family=Open+Sans:400,300'>

  <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.12/d3.min.js"></script>

  <style>
    .nav-bar {
      font-family: 'Open Sans', sans-serif;
      font-weight: 300;

      background-color: rgb(43,43,42);
      color: white;
      font-size: 22px;
      line-height: 35px;
      height: 35px;
      padding: 10px 20px;
    }


    .axis path,
    .axis line {
      fill: none;
      stroke: #999;
      shape-rendering: crispEdges;
    }

    .tick text {
      fill: #666;
    }

    #key-driver-table {
      font-size: 14px;
      line-height: 1.4rem;
      margin-top: 50px;
      width: 100%;
    }

    #key-driver-table th {
      height: 55px;
      font-weight: normal;
      padding: 3px;
      text-align: left;
      vertical-align: top;
    }

    #key-driver-table tbody td {
      border-top: 1px solid whitesmoke;
      padding: 3px;
      vertical-align: top;
    }

    .q-average, 
    .q-importance {
      text-align: right;
    }
  </style>



<body>

  <div class="nav-bar">
    <svg width="35" height="35" style="float: left;">
      <circle r="6" cx="12" cy="12" style="fill: rgb(227, 26, 28);"></circle>
      <circle r="6" cx="26" cy="12" style="fill: rgb(65, 171, 93);"></circle>
      <circle r="6" cx="12" cy="26" style="fill: rgb(254, 178, 76);"></circle>
      <circle r="6" cx="26" cy="26" style="fill: rgb(66, 146, 198);"></circle>
    </svg>
    <div style="margin-left: 40px">Key Driver Analysis</div>
  </div>

  <div style="width: 900px; margin: 50px auto;">
    <select id="select-an-agency">
      <option value="af">Department of the Air Force</option>
      <option value="ag">Department of Agriculture</option>
      <option value="aj">National Endowment For The Arts</option>
      <option value="am">U.S. Agency for International Development</option>
      <option value="ar">Department of the Army</option>
      <option value="bd">Merit Systems Protection Board</option>
      <option value="bf">Defense Nuclear Facilities Safety Board</option>
      <option value="cm">Department of Commerce</option>
      <option value="dd">DoD 4th Estate</option>
      <option value="dj">Department of Justice</option>
      <option value="dl">Department of Labor</option>
      <option value="dn">Department of Energy</option>
      <option value="eb">Export Import Bank</option>
      <option value="ed">Department of Education</option>
      <option value="ep">Environmental Protection Agency</option>
      <option value="fc">Federal Communications Commission</option>
      <option value="fj">Chemical Safety/Hazard Investigation Bd</option>
      <option value="gg">Office of Government Ethics</option>
      <option value="gs">General Services Administration</option>
      <option value="he">Department of Health and Human Services</option>
      <option value="hf">Federal Housing Finance Agency</option>
      <option value="hs">Department of Homeland Security</option>
      <option value="hu">Department of Housing and Urban Development</option>
      <option value="if">Inter-American Foundation</option>
      <option value="in">Department of the Interior</option>
      <option value="ks">Corp For National And Community Service</option>
      <option value="mc">Federal Maritime Commission</option>
      <option value="nn">National Aeronautics and Space Administration</option>
      <option value="nu">Nuclear Regulatory Commission</option>
      <option value="nv">Department of the Navy</option>
      <option value="om">Office of Personnel Management</option>
      <option value="os">Occupational Safety & Health Review Cmsn</option>
      <option value="se">Securities and Exchange Commission</option>
      <option value="si">Small Agencies with Too Few Respondents</option>
      <option value="st">Department of State</option>
      <option value="sz">Social Security Administration</option>
      <option value="td">Department of Transportation</option>
      <option value="tr">Department of the Treasury</option>
      <option value="va">Department of Veterans Affairs</option>
      <option value="va01">- VA Central Office</option>
      <option value="va02">- Veterans Health Administration</option>
      <option value="va03">- Veterans Benefits Administration</option>
    </select>

    <svg id="key-driver-graph"></svg>

    <table id="key-driver-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Question</th>
          <th></th>
          <th>
            <div style="text-align: center">Average</div>
            <div class="rect-axis"></div>
          </th>
          <th style="text-align: right">Importance</th>
        </tr>
      </thead>
      <tbody>

      </tbody>
    </table>
  </div>


  <script>
    var draw = function(data){

      var margin = {top: 40, right: 40, bottom: 55, left: 65},
          width = 940 - margin.left - margin.right,
          height = 600 - margin.top - margin.bottom;
      

      var q_mean = d3.mean(data, function(d){
            return d.mean;
          }),
          coeffs_no_zero = data.filter(function(d){
            return d.coeff > 0;
          }),
          coeff_mean = d3.mean(coeffs_no_zero, function(d){
            return d.coeff;
          });

      var x_s = data.map(function(d){ return d.mean }),
          x_scale = d3.scale.linear()
            .domain([0.5, 5.5])
            .range([0, width]),
          x_axis = d3.svg.axis().scale(x_scale).orient('bottom')
            .tickValues([1,2,3,4,5]);

      var y_s = data.map(function(d){ return d.coeff }),
          y_max = d3.max(y_s),
          y_scale = d3.scale.linear()
            .domain([0, y_max])
            .range([height, 0])
          y_axis = d3.svg.axis().scale(y_scale).orient('left');


      var svg = d3.select('#key-driver-graph .graph');

      if(svg.empty()){
        svg = d3.select('#key-driver-graph')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
          .append('g')
            .attr('class','graph')
            .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
          .append("text")
            .attr("class", "label")
            .attr("x", width/2)
            .attr("y", 50)
            .style("text-anchor", "middle")
            .text("Average Question Score");

        svg.append("g")
            .attr("class", "y axis")
          .append("text")
            .attr("class", "label")
            .attr("transform", "rotate(-90)")
            .attr("x", -height/2)
            .attr("y", -65)
            .attr("dy", ".71em")
            .style("text-anchor", "middle")
            .text("Importance");
      }

      svg.selectAll('.x.axis').transition().call(x_axis);
      svg.selectAll('.y.axis').transition().call(y_axis);

      var q_mean_line = svg.selectAll('line.q_mean')
        .data([q_mean]);

      q_mean_line.enter().append('line')
        .attr('class','q_mean')
        .style({
          'stroke-width': 2,
          'stroke': '#666'
        });

      q_mean_line.transition()
        .attr('x1', x_scale(q_mean))
        .attr('y1', y_scale(0))
        .attr('x2', x_scale(q_mean))
        .attr('y2', y_scale(y_max));


      var coeff_mean_line = svg.selectAll('line.coeff_mean')
        .data([coeff_mean]);

      coeff_mean_line.enter().append('line')
        .attr('class','coeff_mean')
        .style({
          'stroke-width': 2,
          'stroke': '#666'
        });

      coeff_mean_line.transition()
        .attr('x1', x_scale(0.5))
        .attr('y1', y_scale(coeff_mean))
        .attr('x2', x_scale(5.5))
        .attr('y2', y_scale(coeff_mean));


      var circle_data = data.filter(function(d){ return d.coeff > 0 });

      var circles = svg.selectAll('circle')
        .data(circle_data, function(d){ return d.q; });
        
      circles.enter().append('circle')
        .attr('r', 5)
        // .style('opacity', 0.8)
        .style('fill','white')
        .style('fill-opacity',0)
        .style('stroke-width',2)
        .style('stroke','#999');

      circles.transition()
        .attr('cx', function(d){ return x_scale(d.mean) })
        .attr('cy', function(d){ return y_scale(d.coeff) })
        .style('stroke', function(d){
          if(d.mean >+ q_mean && d.coeff >= coeff_mean)
            return 'rgb(65, 171, 93)';
          else if(d.mean < q_mean && d.coeff >+ coeff_mean)
            return 'rgb(227, 26, 28)';
          else if(d.mean < q_mean && d.coeff < coeff_mean)
            return 'rgb(254, 178, 76)';
          else
            return 'rgb(66, 146, 198)';
        });

        circles.exit().remove();


      var labels = svg.selectAll('.data-label')
        .data(circle_data, function(d){ console.log(d); return d.q; });
        
      labels.enter().append('text')
        .attr('class','data-label')
        .attr('dx', 10)
        .attr('dy', 5)
        .style('font-size', '12px')
        // .style('opacity',0.7)
        .style('fill','#999');

      labels.text(function(d){ return d.q.toUpperCase(); })
        .transition()
        .attr('x', function(d){ return x_scale(d.mean) })
        .attr('y', function(d){ return y_scale(d.coeff) })
        .style('fill', function(d){
          if(d.mean >+ q_mean && d.coeff >= coeff_mean)
            return 'rgb(65, 171, 93)';
          else if(d.mean < q_mean && d.coeff >+ coeff_mean)
            return 'rgb(227, 26, 28)';
          else if(d.mean < q_mean && d.coeff < coeff_mean)
            return 'rgb(254, 178, 76)';
          else
            return 'rgb(66, 146, 198)';
        });

        labels.exit().remove();


      var rows = d3.select('#key-driver-table tbody').selectAll('tr')
            .data(data, function(d){
              return d.q;
            }),
          svg_width = 160,
          svg_height = 20,
          rect_height = 10,
          rect_width = 150,
          rect_y = (svg_height - rect_height)/2;


      if(d3.select('.rect-axis svg').empty()){
        var rect_axis_svg = d3.select('.rect-axis').append('svg')
              .attr({ width: svg_width, height: 20})
              .style('font-size','10px');

        var rect_scale = d3.scale.linear()
              .domain([1,5])
              .range([0, rect_width]),
            rect_axis = d3.svg.axis().scale(rect_scale).orient('top')
              .tickValues([1,2,3,4,5])
              .tickFormat(d3.format('0f'));

          rect_axis_svg.append("g")
            .attr("class", "x axis")
            .attr('transform','translate(5,20)')
          rect_axis_svg.selectAll('.x.axis').transition().call(rect_axis);
      }

      rows.enter().append('tr')
        .each(function(d){
          var r = d3.select(this);

          r.append('td').attr('class', 'q-number');
          r.append('td').attr('class', 'q-text');
          r.append('td').attr('class', 'q-average');
          r.append('td').attr('class', 'q-average-svg')
            .append('svg')
              .attr({ width: svg_width, height: svg_height })
            .append('g')
              .attr('transform','translate(5,0)')
              .attr('class','graph');
          r.append('td').attr('class', 'q-importance');

        });
      
      var dist_colors = ['#d7191c','#fdae61','#ffffbf','#a6d96a','#1a9641'],
          format = d3.format('.2f');

      rows.each(function(d){
          var r = d3.select(this),
              x0 = 0,
              dist = [1,2,3,4,5].map(function(i){ 
                var value = d[i]/d.n
                return { value: value,  x0: x0, x1: x0 += value }; 
              });

          r.select('.q-number').text(d.q.toUpperCase());
          r.select('.q-text').text(questions[d.q]);
          r.select('.q-average').text(format(d.mean));
          if(d.coeff > 0)
            r.select('.q-importance').text(format(d.coeff));

          var rects = r.select('.q-average-svg g.graph').selectAll('rect')
            .data(dist, function(d,i){ return i; });

          rects.enter().append('rect')
            .attr('y', rect_y)
            .attr('height', rect_height)
            .style('fill', function(d,i){ 
              return dist_colors[i]; 
            })
            .style('opacity', 0.7);

          rects.transition()
            .attr('width', function(d){
              return rect_width * d.value;
            })
            .attr('x', function(d){
              return rect_width * d.x0;
            });

          var means = r.select('.q-average-svg svg').selectAll('line')
            .data([d.mean]);

          means.enter().append('line')
            .attr('y1', 0)
            .attr('y2', svg_height)
            .style('stroke-width', 1.5)
            .style('stroke','rgb(43,43,42)');


           means.transition()
            .attr('x1', function(d){
              return (d - 1) / 4 * rect_width;
            })
            .attr('x2', function(d){
              return (d - 1) / 4 * rect_width;
            })

        });



    };


    var get_data = function(){

      var agency = $('#select-an-agency').val();      

      d3.csv('./data/key_driver_' + agency + '.csv', function(data){
        data.forEach(function(d){
          Object.keys(d).forEach(function(k){
            if(k != 'q')
              d[k] = +d[k];
          })
        });

        draw(data);
      });

    };

    d3.select('#select-an-agency').on('change', get_data);


    d3.json('./data/question_text.json', function(data){
      window.questions = data;
      get_data();
    });
    

  </script>