<!DOCTYPE html>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" >
<!-- jruby -run -e httpd . -p 9090 -->

<head>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.1/animate.min.css">
  <link rel='stylesheet' href='//fonts.googleapis.com/css?family=Open+Sans:400,300'>

  <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.12/d3.min.js"></script>

  <script type="text/javascript" src="./retirement_model_full.js"></script>

  <style>
    body {
      font-size: 16px;
    }

    .nav-header {
      font-family: 'Open Sans', sans-serif;
      font-weight: 300;

      background-color: whitesmoke;
      color: rgb(43,43,42);
      font-size: 22px;
      line-height: 35px;
      height: 55px;
      padding: 10px 20px;
    }


    .axis path,
    .axis line {
      fill: none;
      stroke: #999;
      shape-rendering: crispEdges;
    }

    .tick text {
      fill: #666;
      font-size: 15px;
    }

  </style>



<body>

  <div class="nav-header">
    <div>
      <svg width="35" height="35" style="float: left;">
        <circle r="6" cx="12" cy="12" style="fill: rgb(227, 26, 28);"></circle>
        <circle r="6" cx="26" cy="12" style="fill: rgb(65, 171, 93);"></circle>
        <circle r="6" cx="12" cy="26" style="fill: rgb(254, 178, 76);"></circle>
        <circle r="6" cx="26" cy="26" style="fill: rgb(66, 146, 198);"></circle>
      </svg>
      <div style="margin-left: 40px">Model Profiler</div>
    </div>
  </div>


  <div style="width: 960px; margin: 50px auto;">
  
    <p>The Model Profiler allows you to explore multivariate regression effects. Click and drag the points for each plot to explore how the variables interact across the model.</p>
    <div id="model-profiler-parent" style="position: relative;">
      <svg id="model-profiler"></svg>
    </div>

  </div>


  <script>
  var vamcs = ['Albuquerque, NM','Alexandria, LA','All Others','Altoona, PA','Amarillo, TX','Anchorage, AK','Ann Arbor, MI','Asheville, NC','Atlanta {Decatur}, GA','Augusta, GA','Baltimore HCS, MD','Battle Creek, MI','Bay Pines, FL','Beckley, WV','Bedford, MA','Big Spring, TX','Biloxi, MS','Birmingham, AL','Black Hills HCS, SD','Boise, ID','Boston HCS, MA','Bronx, NY','Buffalo, NY','Butler, PA','Central Texas HCS, TX','Charleston, SC','Cheyenne, WY','Chicago HCS, IL','Chillicothe, OH','Cincinnati, OH','Clarksburg, WV','Cleveland, OH','Coatesville, PA','Columbia, SC','Columbus, OH','Connecticut HCS, CT','Dallas, TX','Danville, IL','Dayton, OH','Denver, CO','Detroit, MI','Dublin, GA','Durham, NC','El Paso, TX','Erie, PA','Fargo, ND','Fayetteville, AR','Fayetteville, NC','Fresno, CA','Gainesville, FL','Grand Junction, CO','Hampton, VA','Hines, IL','Honolulu, HI','Houston, TX','Hudson Valley HCS, NY','Huntington, WV','Indianapolis, IN','Iron Mountain, MI','Jackson, MS','Kansas City, MO','Las Vegas, NV','Lebanon, PA','Lexington, KY','Little Rock, AR','Loma Linda, CA','Long Beach, CA','Los Angeles HCS, CA','Louisville, KY','Madison, WI','Manchester, NH','Manila, PI','Martinsburg, WV','Memphis, TN','Miami, FL','Mid Tenn. HCS, TN','Milwaukee, WI','Minneapolis, MN','Montana HCS, MT','Montgomery, AL','Mountain Home, TN','Muskogee, OK','NY Harbor HCS, NY','Nebraska-W Iowa, NE','New Jersey HCS, NJ','New Orleans, LA','North Arizona HCS, AZ','North Calif HCS, CA','North Chicago, IL','North Indiana HCS, IN','Northampton, MA','Northport, NY','Oklahoma City, OK','Orlando, FL','Palo Alto, CA','Philadelphia, PA','Phoenix, AZ','Pittsburgh, PA','Portland, OR','Providence, RI','Puget Sound HCS, WA','Reno, NV','Richmond, VA','Roseburg, OR','Saginaw, MI','Salem, VA','Salisbury, NC','Salt Lake City, UT','San Diego, CA','San Francisco, CA','San Juan, PR','Sheridan, WY','Shreveport, LA','Sioux Falls, SD','South Arizona HCS, AZ','South Texas HCS, TX','Spokane, WA','St. Cloud, MN','St. Louis, MO','Tampa, FL','Texas Valley Coast HCS','Togus, ME','Tomah, WI','Tuscaloosa, AL','Walla Walla, WA','Washington, DC','West Palm Beach, FL','White City, OR','White River Jct., VT','Wilkes-Barre, PA'];

  var model = {
    equation: model_formula,
    y: { type: 'continuous', min: 0, max: 1, title: 'Predicted Retirement Probability', format: d3.format('.1%') },
    variables: {
      age: { type: 'continuous', min: 45, max: 85, mean: 62, title: 'Age', increment: 1, format: d3.format('0f') },
      tenure: { type: 'continuous', min: 0, max: 60, mean: 25, title: 'Tenure', increment: 1, format: d3.format('0f') },
      step: { type: 'ordinal', values: ['01','02','03','04','05','06','07','08','09','10','11','12','13','XX'], mode: '12', title: 'Step' },
      review: { type: 'ordinal', values: ['Low','Moderate','High'], mode: 'Moderate', title: 'Review' },
      grade: { type: 'ordinal', values: [1,2,3,4,5,6,7,99], mode: 2, title: 'Grade' },
      vamc: { type: 'nominal', values: vamcs, mode: 'Pittsburgh, PA', title: 'VA Medical Center' },
      occ: { type: 'nominal', values: ['610','620','621'], mode: '610', title: 'Occupational Series' },
      unemployment: { type: 'continuous', min: 0.05, max: 0.26, mean: 0.07, increment: 0.01, title: 'Unemployment', format: d3.format('.1%') }
    }
  };

  var variables = Object.keys(model.variables),
      current_means;


  var margin = { left: 150, top: 100, bottom: 50, right: 50 },
      graph_height = 232,
      svg_height = Math.ceil(variables.length / 3) * (graph_height + 50) + margin.top + 150,
      svg_width = 960;

  var percent_format = d3.format('0%');


  var svg = d3.select('svg#model-profiler')
        .attr({ height: svg_height, width: svg_width }),
      svg_parent = d3.select('div#model-profiler-parent');

  var y = d3.scale.linear()
        .domain([model.y.min, model.y.max])
        .range([graph_height, 0]),
      y_axis = d3.svg.axis()
        .scale(y).orient('left')
        .tickFormat(percent_format)
        .tickValues([0,.2,.4,.6,.8,1]);

  var title = svg.append('text')
    .attr('class','title')
    .attr('x', 200)
    .attr('y', 60)
    .attr('dy', '1em')
    .attr('text-anchor','middle')

  var updateTitle = function(y){
    title.text(model.y.title + ': ' + model.y.format(y));
  }


  var collect_means = function(){
    var t = {};
    variables.map(function(v){
      var mean = model.variables[v].mean;
      t[v] = mean ? mean : model.variables[v].mode;
    })
    return t;
  };


  var updateInputs = function(current_means, changed_v){
    var v_i = model.variables[changed_v],
        value = current_means[changed_v];
    if(v_i.type == 'continuous'){
      value = v_i.format(value);
    }
    d3.select('#input-' + changed_v)[0][0].value = value;
  };


  var updateCharts = function(current_means, changed_v){
    var predicted_p = model.equation(current_means),
        predicted_y = y(predicted_p);

    variables.forEach(function(v){
      var v_i = model.variables[v],
          plot_data = get_plot_data(current_means, v),
          plot = d3.select('.' + v);
      plot.selectAll('path.response-curve')
        .attr('d', v_i.path_generator(plot_data));

      plot.selectAll('circle')
        .attr('cx', v_i.x(current_means[v]))
        .attr('cy', predicted_y);
    });

    d3.selectAll('line.predicted-p')
      .attr('y1', predicted_y)
      .attr('y2', predicted_y);

    d3.selectAll('text.predicted-p')
      .text(model.y.format(predicted_p))
      .attr('y', predicted_y);
  };


  var updateContinuousMean = function(x_value){
    if(v_i.type == 'continuous'){
      var x_value = v_i.x.invert((cx += d3.event.dx));
      current_means[v] = x_value;
      current_means[v] = current_means[v] < domain[0] ? domain[0] : current_means[v];
      current_means[v] = current_means[v] > domain[1] ? domain[1] : current_means[v];
    } else {
      current_means[v] = domain[d3.bisect(range, d3.event.x) - 1];
    }
  }




  var get_plot_data = function(current_means, v){
    var t = {};
   
    Object.keys(current_means).forEach(function(k){
      t[k] = current_means[k];
    });

    var v_i = model.variables[v],
        domain = v_i.x.domain(),
        plot_data = [];

    if(v_i.type == 'continuous'){
      var inc = domain[0];
      while(inc < domain[1]){
        t[v] = inc;
        plot_data.push({ x: t[v], y: model.equation(t) });
        inc += v_i.increment;
      }
    } else {
      domain.forEach(function(d){
        t[v] = d;
        plot_data.push({ x: t[v], y: model.equation(t) });
      });
    }

    return plot_data;
  };

  current_means = collect_means();
    
  variables.forEach(function(v,i){
    var v_i = model.variables[v];

    var mod = i%3,
        left = mod * (graph_height + 50) + margin.left,
        top = Math.floor(i/3) * (graph_height + margin.top) + margin.top;

    var g = svg.append('g')
      .attr('class', v)
      .attr('transform','translate(' + left + ',' + top + ')');

    if(mod % 3 === 0){
      g.append('g')
        .attr('class', 'y axis')
        .call(y_axis)
          .append('text')
            .attr('text-anchor','middle')
            .text(model.y.title)
            .attr('transform','rotate(-90) translate(-110,-130)')
            .style('fill','#888')
            .style('font-size','14px');
    }


    if(v_i.type == 'continuous'){
      v_i.x = d3.scale.linear()
        .domain([v_i.min,v_i.max])
        .range([0, graph_height]);

      v_i.x_axis = d3.svg.axis()
        .scale(v_i.x)
        .orient('bottom')
        .ticks(6)
        .tickFormat(v_i.format);

    } else if(['ordinal','nominal'].indexOf(v_i.type) >= 0){
      v_i.x = d3.scale.ordinal()
        .domain(v_i.values)
        .rangePoints([0, graph_height]);
      
       v_i.x_axis = d3.svg.axis()
        .scale(v_i.x)
        .orient('bottom')
        .outerTickSize(0);

      if(v_i.values.length > 6){
         v_i.x_axis.tickValues([]);
      } else if(v_i.values.length > 6){
        x_axis.tickValues(v_i.x.domain().filter(function(d,i){
          return !(i % Math.floor(v_i.values.length / 6))
        }));
      }
    }


    var g_x_axis = g.append('g')
      .attr('class', 'x axis')
      .attr('transform', 'translate(0,' + graph_height + ')')
        .call(v_i.x_axis)
      .append('text')
      .text(v_i.title)
        .attr({ x: graph_height / 2 })
        .attr('dy', 85)
        .attr('text-anchor','middle')
        .style({ 'fill': 'darkgray', 'font-size': '14px' });

    var g_input = svg_parent.append('div')
      .style('position','absolute')
      .style('top', top  + graph_height + 30 + 'px')
      .style('left', left + 50 + 'px')

    if(v_i.type == 'continuous'){
      g_input.append('input')
        .attr('type','text')
        .attr('value', v_i.format(v_i.mean))
        .attr('class','form-control')
        .attr('id', 'input-' + v)
        .style('width',graph_height - 100 + 'px')
        .style('text-align', 'center')
        .on('input', function(d){

          var value = parseFloat(this.value),
              domain = v_i.x.domain();

          value = value < domain[0] ? domain[0] : value;
          value = value > domain[1] ? domain[1] : value;
          current_means[v] = value;
          updateCharts(current_means, v);
        });
    } else {
      g_input.append('select')
        .on('change', function(d){
          current_means[v] = this.value;
          updateCharts(current_means, v);
        })
        .attr('class','form-control')
        .attr('id', 'input-' + v)
        .style('width', graph_height - 100 + 'px')
          .selectAll('option')
            .data(v_i.values)
          .enter().append('option')
            .text(function(d){ return d; })
            .attr('value', function(d){ return d; })
            .property('selected', function(d){
              return d == current_means[v] 
            });
    }



    v_i.path_generator = d3.svg.line()
        .x(function(d) { return v_i.x(d.x); })
        .y(function(d) { return y(d.y); })
        .interpolate('linear');

   
 
    var t = collect_means(),
        plot_data = get_plot_data(t, v),
        predicted_p = model.equation(t),
        mean = [v_i.x(t[v]), y(predicted_p)],
        domain = v_i.x.domain(),
        range = v_i.x.range();

      g.append('line')
        .attr('class','predicted-p')
        .attr('x1', function(){
          var x1 = v_i.x(domain[0]);
          return mod == 0 ? x1 : x1 - 50;
        })
        .attr('y1',mean[1])
        .attr('x2', v_i.x( domain[domain.length - 1] ))
        .attr('y2',mean[1])
        .style('stroke-width', 1.5)
        .style('stroke','lightgray')
        .style('fill','none');

      if(mod == 0){
        g.append('text')
        .attr('class','predicted-p')
        .attr('x', function(){
          var x1 = v_i.x(domain[0]);
        })
        .attr('y',mean[1])
        .attr('dx','-110')
        .attr('dy','0.3em')
        .text(model.y.format(predicted_p))
        .style('fill','red');
      }

      g.append('path')
        .attr('class','response-curve')
        .attr('d', v_i.path_generator(plot_data))
        .style('stroke-width', 3)
        .style('stroke','red')
        .style('fill','none');




      g.selectAll('circle').data([mean])
          .enter().append('circle')
        .attr('cx',function(d){ return d[0] })
        .attr('cy',function(d){ return d[1] })
        .attr('r', 6)
        .attr('tabindex','0')
        .style('stroke-width',3.5)
        .style('stroke','red')
        .style('fill','white')
          .attr("cursor", "move")
      .call(
        d3.behavior.drag().on('drag', function(d,i){
          if(v_i.type == 'continuous'){
            var x_value = +d3.select(this).attr('cx') + d3.event.dx;

            x_value = v_i.x.invert((x_value));
            current_means[v] = x_value;
            current_means[v] = current_means[v] < domain[0] ? domain[0] : current_means[v];
            current_means[v] = current_means[v] > domain[1] ? domain[1] : current_means[v];
          } else {
            current_means[v] = domain[d3.bisect(range, d3.event.x) - 1];
          }

          var predicted_p = model.equation(current_means),
              predicted_y = y(predicted_p);

          d3.select(this)
            .attr('cx', v_i.x(current_means[v]) )
            .attr('cy', predicted_y);

          updateInputs(current_means, v);
          updateCharts(current_means, v);
        })
      );



  });


  </script>

  <style>
  </style>